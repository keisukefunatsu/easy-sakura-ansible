- name: ディレクトリを作成する
  file:
    path: "~/www/{{ working_directory }}"
    state: directory

- name: WordPress日本語版をダウンロードする
  command: "wp core download --locale=ja"
  args:
    chdir: "~/www/{{ working_directory }}"
    creates: index.php

- name: wp-config.phpを作成する
  command: |
    wp config create
    --dbname={{ site_db_name }}
    --dbuser={{ sakura_db_user }}
    --dbpass={{ sakura_db_pass }}
    --dbhost={{ sakura_db_host }}
    --dbprefix={{ site_db_prefix | default('wp_') }}
    --extra-php="{{ extra_php }}"
  args:
    chdir: "~/www/{{ working_directory }}"
    creates: wp-config.php

- name: WordPressをインストールする
  command: |
    wp core install
    --url='{{ site_url }}'
    --title='{{ site_title }}'
    --admin_user='{{ site_admin_name }}'
    --admin_password='{{ site_admin_pass }}'
    --admin_email='{{ site_admin_mail }}'
  args:
    chdir: "~/www/{{ working_directory }}"

- name: 共通プラグインをインストールする
  command: "wp plugin install {{ item }} --activate"
  args:
    chdir: "~/www/{{ working_directory }}"
  with_items: "{{ common_plugins }}"

- name: 環境独自のプラグインをインストールする
  command: "wp plugin install {{ item }} --activate"
  args:
    chdir: "~/www/{{ working_directory }}"
  with_items: "{{ site_plugins }}"


- name: パーマリンク構造を変更
  command: wp rewrite structure '/%postname%/'
  args:
    chdir: "~/www/{{ working_directory }}"

- name: パーマリンク設定を更新する
  command: wp rewrite flush
  args:
    chdir: "~/www/{{ working_directory }}"
