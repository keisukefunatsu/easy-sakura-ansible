#!/usr/bin/env bash

BACKUP_DIR=${HOME}/wp_backup
BACKUP_DATE=$(date +"%Y%m%d")
BACKUP_TIME=$(date +"%H%M%S")
BACKUP_DATETIME="${BACKUP_DATE}_${BACKUP_TIME}"

# 階層的にbackupフォルダを作成
mkdir -p ${BACKUP_DIR}/production
mkdir -p ${BACKUP_DIR}/staging
# backup用のディレクトリがなければ終了
cd ${BACKUP_DIR}/production || exit 1;
cd ${BACKUP_DIR}/staging || exit 1;

# productionディレクトリがあれば処理をする
cd /home/"{{sakura_user_name}}"/www/"{{production_directory}}" || exit 1;
wp db export ${BACKUP_DIR}/production/back_up${BACKUP_DATETIME}.sql
find "${BACKUP_DIR}/production" -type f -name "*.sql" -mtime +5 -print0 | xargs rm -f

# stagingディレクトリがあれば処理をする
cd /home/"{{sakura_user_name}}"/www/"{{staging_directory}}" || exit 1;
wp db export ${BACKUP_DIR}/staging/back_up${BACKUP_DATETIME}.sql
find "${BACKUP_DIR}/staging" -type f -name "*.sql" -mtime +5 -print0 | xargs rm -f
